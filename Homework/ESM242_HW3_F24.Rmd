---
title: "EM 242 HW 3"
author: "Andrew Plantinga"
date: "2024-10-22"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(nloptr)
library(knitr)
```

**Notes from class** 

## Question 1:

- First problem looks at solving forest rotation for one rotation and for an inifinite number of rotations 
  - What about something in between? Like here if you grew your stand for six different rotations 
    - rotation length are not going to be equal to each other (need 6 values that you're choosing)
    - The key to this problem is to keep track of time, and to get the discounting happening at the right times 
    - What you have to think about: 
    
IF we were to write a timeline 

t0,
t1 = end of first rotation, t1 
t2 = t1 + t2 
t3 = t1 + t2 + t3 
t4 = t1 + t2 + t3 + t4  
t5 = t1 + t2 + t3 + t4 + t5 
t6 = t1 + t2 + t3 + t4 + t5 + t6 

When do the costs occur??

- They would occur in t0, up to t5, because you aren't planting after the sixth rotation 

When do the revenues occur? 

- They would occur in t1 $pQ(T_{1})$, t2 $pQ(T_{2})$, t3 $pQ(T_{3})$, t4 $pQ(T_{4})$, t5 $pQ(T_{5})$, t6 $pQ(T_{6})$

So now looking at revenues... 

- We have to add up revenues and costs from the revenue and cost stream in such a way that profits are added up but discounted appropriately 

Andrew suggests that your choices are going to be the amount of time in between rotations, like choice[1], choice[2], choice[3], and state[1]=choice[1], state[2]=state[1]+choice[2], state[3]=state[2]+choice[3]

- The trick is to identify how much total time has passed so that you discount it appropriately 
  - The discounting term is going to depend on the choices that were made to maximize PVNB 
  - For example: 
    
```{r}
#| eval: false
for(i in 2:6) { 
  state[i]=state[i-1]+choice[i] # Because the state[i-1] in this case is choice[i-1]
  benefits[i]=p*Q(choice[i])*exp(-discount*state[i])-c*exp(-discount*state[i-1])
  # The benefits in state i are a function of the price you get for timber*the quantity of timber for your choice in time i, discounted by the total time that has passed (state[i]), minus the cost associated with state[i-1], which is the second term in the equation
  }
```

## Question 1: Forestry Rotation {.tabset}

This problem expands on the forest rotation problem presented in class.  Suppose that a stand of trees is planted in time 0 at a cost of c, grown for $T_1$ years, harvested, replanted at cost c, grown for $T_2$ years, harvested, replanted, and so on.  If we complete six rotations, what should be the values of $T_1$, $T_2$, $T_3$, $T_4$, $T_5$, and $T_6$?  Assume that different values can be chosen for each year and that the stand does not need to be replanted after the sixth harvest.  Use the parameter values a=10, b=53.27, c=250, p=1.5, and $\delta$=0.05.

### A.

Before you solve the problem for six rotations, find the optimal rotation when only one rotation is done.  What is the optimal value of $T_1$?

$$
\mathrm{ Q(T)=e^{a-b/T} \\ 
\max_{T_1} ~\Pi_{1}=pQ(T_{1})e^{-\delta T_{1}}-c}
$$ 

```{r}

forest_fct <- function(choice, c, p, a, b, discount) {
  
  Q=exp((a-b)/choice)
  benefits=p*Q*exp(-discount*choice) - c
  return(-benefits)
}

options=list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-8,maxeval=16000)

out_1a=nloptr(x0=1,
              eval_f=forest_fct,
              opts=options,
              lb=0,
              a=10,
              b=53.27,
              c=250,
              p=1.5,
              discount=1/1.05
              )
out_1a$solution
out_1a$objective

```


### B. 

Now solve the problem for six consecutive rotations.  What are the six rotation lengths that you found?

<span style="color: blue;">**Solution**
</span>



```{r}

forest_b <- function(choice, a, b, c, p, discount, period) {
  
  state=vector(mode="numeric", length=0)
  benefits=vector(mode="numeric", length=0)
  Q=vector(mode="numeric", length=0)
  
  state[1]=choice[1]
  Q[1]=exp(a-b/choice[1])
  benefits[1]=p*Q[1]*exp(-discount*state[1])
    
  for(i in 2:period){
    state[i]=state[i-1] + choice[i]
    Q[i]=exp(a-b/choice[i])
    benefits[i]=p*Q[i]*exp(-discount*state[i])
  }
  
  pv=discount^state[i]*benefits[i] 
  
  npv=sum(pv)
  
  return(-npv)
}


options=list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-8,maxeval=16000)

period=6
out_1b=nloptr(x0=rep(1, period),
              eval_f=forest_b,
              opts=options,
              lb=rep(0, period),
              a=10,
              b=53.27,
              c=250,
              p=1.5,
              period=6,
              discount=0.05
              )

out_1b$solution

```



### C.

Explain why $T_1$ through $T_5$ are shorter than $T_6$?

<span style="color: blue;">**Solution**
</span>

<span style="color: blue;">

</span>

### D.

What happens to $T_1$ through $T_5$ when the cost of replanting the stand increases to 500? Explain. Why doesn't $T_6$ change with the higher replanting cost?


```{r}

options=list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-8,maxeval=16000)

```

<span style="color: blue;">**Solution**
</span>

<span style="color: blue;">


</span>



### E.

Compare your answer to part a (the single rotation) to $T_6$. Why are they the same?

<span style="color: blue;">**Solution**
</span>

<span style="color: blue;">


</span>


### F

Now solve for the optimal rotation when an infinite number of rotations are done.  Compute the present value of net revenues (i.e., $objective).  Compare this to the present value of net revenues when only six rotations are done.  Are they close in magnitude?  Why?

```{r}

options=list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-8,maxeval=16000)

```

## Question 2: Varying Initial Age {.tabset}

## Question 2 

- Start with your trees of age a, decide how long to grow the first rotation, which will be followed by an infinite number of rotations 

A = initial age 
t1 = time until first harvest 
Age at first harvest = A + t1 
Volume at first harvest = Q(A+t1)

- How do you write the present value of an infinite number of rotations when the first rotation is going to give you that first volume 
  - The only thing you need to choose is the first time interval, t1 
- What about all the other rotations that occur after that? 
  - in A we solve for T* when the initial age is zero, and call that solution $\Pi_{\infty}$ 
  - And $\Pi_{\infty}$ is the present value of an infinite number of rotations starting at age 0
  - So now in the problem where we have an initial age, you decide t1 and then do an infinite number of rotations where each subsequent rotation starts with a biomass value of 0
  - When you finish part a and go to the nonzero initial age, the only thing you need to choose is t1 

In this problem, you are asked to find the optimal rotation when the initial age of the stand is not zero.  The key question is whether a positive initial age should change the solution.  That is, if T* is the optimal rotation age for a stand starting at age 0, will it still be the same optimal rotation age for a stand starting at age $A$>0?  The volume of timber evolves according to $Q(T)=e^{a-b/T}$  where a=13, b=185, and T is the age of the trees. The price of timber is p=1.78 and the cost of planting the stand at the start of each rotation is 1000.  The discount rate is $\delta$=0.05.  

### A.
	
If the stand is grown for an infinite number of rotations, what is the optimal rotation length when the initial age of the stand is zero?  Call this value $T^*$.  What is the present discounted value of net timber revenues from an infinite number of rotations?  Call this value $\pi_\infty$.

<span style="color: blue;">**Solution**</span>



```{r}



options=list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-15,maxeval=16000)


```



### B.

Suppose that the initial age of the stand is A and $T_1$ is the additional number of years the stand is grown until harvest.  Then, $A+T_1$ is the age of the stand at the end of the first rotation. Assuming the first rotation is followed by an infinite number of rotations, write an expression for present discounted value of net timber revenues from an infinite number of rotations (including the first one).

<span style="color: blue;">**Solution**</span>

<span style="color: blue;">


</span>

### C.

Using your formula in b, and assuming A=30, what is the optimal value of $T_1$? How does your answer change when A=40?  A=60.14?  A=90?  Make a table showing your results.

<span style="color: blue;">**Solution**</span>



```{r}



```

### D.

What do you notice about $A+T_1$?  Explain.

<span style="color: blue;">**Solution**</span>

<span style="color: blue;">


</span>


